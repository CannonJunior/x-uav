services:
  # ArangoDB Graph Database
  arangodb:
    image: arangodb:latest
    container_name: x-uav-arangodb
    environment:
      ARANGO_ROOT_PASSWORD: development
    ports:
      - "8529:8529"
    volumes:
      - ./data/arangodb:/var/lib/arangodb3
    networks:
      - x-uav-network
    restart: unless-stopped

  # PostgreSQL for relational data
  postgres:
    image: postgres:16-alpine
    container_name: x-uav-postgres
    environment:
      POSTGRES_DB: xuav
      POSTGRES_USER: xuav
      POSTGRES_PASSWORD: development
    ports:
      - "5432:5432"
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
    networks:
      - x-uav-network
    restart: unless-stopped

  # Redis for caching and real-time features
  redis:
    image: redis:7-alpine
    container_name: x-uav-redis
    ports:
      - "6379:6379"
    volumes:
      - ./data/redis:/data
    networks:
      - x-uav-network
    restart: unless-stopped
    command: redis-server --appendonly yes

  # FastAPI Backend (development)
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.dev
    container_name: x-uav-backend
    environment:
      - ENVIRONMENT=development
      - PORT=8000
      - DATABASE_URL=postgresql://xuav:development@postgres:5432/xuav
      - GRAPH_DB_URL=http://arangodb:8529
      - REDIS_URL=redis://redis:6379
      - OLLAMA_URL=http://host.docker.internal:11434
    ports:
      - "8000:8000"
    volumes:
      - ./backend:/app
      - /app/.venv  # Don't mount venv from host
    networks:
      - x-uav-network
    depends_on:
      - arangodb
      - postgres
      - redis
    restart: unless-stopped
    command: uv run uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

  # Vue.js Frontend (development)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    container_name: x-uav-frontend
    environment:
      - NODE_ENV=development
      - VITE_API_URL=http://localhost:8000
    ports:
      - "7676:7676"
    volumes:
      - ./frontend:/app
      - /app/node_modules  # Don't mount node_modules from host
    networks:
      - x-uav-network
    depends_on:
      - backend
    restart: unless-stopped
    command: npm run dev -- --host 0.0.0.0 --port 7676

networks:
  x-uav-network:
    driver: bridge
